<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChaosTech NSD v12.4 - Military Command AI System</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #00ff00; }
        
        #app { display: flex; width: 100%; height: 100%; }
        #radar { flex: 1; display: flex; flex-direction: column; border-right: 2px solid #00ff00; padding: 5px; perspective: 1000px; }
        canvas { flex: 1; background: #000; border: 2px solid #00ff00; }
        
        #main-panel { display: flex; flex: 0 0 1000px; border-left: 2px solid #00ff00; }
        #control-panel { width: 340px; background: #0a0a0a; border-right: 2px solid #00ff00; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; font-size: 12px; }
        #intel-panel { flex: 1; background: #0a0a0a; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        
        .box { border: 1px solid #00aa00; background: #0f0f0f; padding: 8px; }
        .box h3 { font-size: 13px; color: #00ff00; text-transform: uppercase; border-bottom: 1px solid #00aa00; padding-bottom: 4px; margin-bottom: 8px; font-weight: bold; letter-spacing: 1px; }
        
        .stat { display: flex; justify-content: space-between; font-size: 12px; padding: 5px 6px; background: #1a1a1a; margin-bottom: 4px; }
        .stat-val { font-weight: bold; font-size: 13px; }
        .stat-val.red { color: #ff0000; }
        .stat-val.yellow { color: #ffff00; }
        .stat-val.cyan { color: #00ccff; }
        
        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        button { padding: 8px; background: #1a1a1a; color: #00ff00; border: 1px solid #00aa00; font-family: 'Courier New', monospace; font-size: 11px; cursor: pointer; font-weight: bold; }
        button:hover { background: #00ff00; color: #000; }
        button.danger { color: #ff0000; border-color: #ff0000; }
        button.danger:hover { background: #ff0000; color: #fff; }
        button.wide { grid-column: 1 / -1; }
        button.active { background: #004466; box-shadow: 0 0 10px #00ccff; }
        button.sm { padding: 6px; font-size: 10px; }
        
        #log { flex: 1; background: #000; border: 1px solid #00ff00; padding: 6px; overflow-y: auto; font-size: 10px; line-height: 1.4; max-height: 150px; }
        .log-line { margin-bottom: 2px; color: #00ff00; }
        .log-line.threat { color: #ff0000; font-weight: bold; }
        .log-line.jam { color: #ffff00; font-weight: bold; }
        .log-line.detect { color: #0099ff; }
        .log-line.ai { color: #cc00ff; font-weight: bold; }
        
        #status { padding: 6px; background: #1a1a1a; border: 1px solid #00ff00; font-size: 11px; text-align: center; font-weight: bold; }
        #status.ready { background: #003300; color: #00ff00; }
        
        .priority-row { display: flex; gap: 3px; margin-bottom: 3px; }
        .priority-name { flex: 0 0 40px; color: #00ff00; font-weight: bold; font-size: 10px; }
        .priority-bar { flex: 1; background: #1a1a1a; border: 1px solid #00aa00; height: 16px; display: flex; align-items: center; }
        .priority-fill { height: 100%; background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00); transition: width 0.3s; }
        .priority-label { font-size: 8px; padding: 0 2px; color: #fff; font-weight: bold; }
        
        .formation-display { font-size: 11px; background: #1a3a1a; border: 1px solid #00ff00; padding: 6px; text-align: center; }
        .formation-type { color: #00ff00; font-weight: bold; font-size: 16px; }
        .formation-info { color: #00aa00; font-size: 10px; margin-top: 4px; }
        
        .rf-entry { background: #1a1a1a; padding: 3px; margin-bottom: 3px; border-left: 2px solid #00ccff; font-size: 10px; }
        .rf-id { color: #00ccff; font-weight: bold; }
        .rf-match { color: #00ff00; }
        
        .escalation-step { flex: 1; padding: 5px; text-align: center; background: #1a1a1a; border: 1px solid #003300; color: #00aa00; font-size: 10px; font-weight: bold; }
        .escalation-step.active { background: #003300; color: #00ff00; }
        
        .timeline-item { background: #1a1a1a; padding: 4px; margin-bottom: 2px; border-left: 1px solid #00ccff; font-size: 10px; color: #00aa00; }
        .timeline-time { color: #00ff00; font-weight: bold; }
        
        .effectiveness-bar { height: 20px; background: #1a1a1a; border: 1px solid #00aa00; margin: 4px 0; }
        .effectiveness-fill { height: 100%; background: linear-gradient(90deg, #ff0000, #ffaa00, #00ff00); transition: width 0.5s; }
        
        .heatmap-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; margin: 4px 0; }
        .heatmap-cell { width: 100%; aspect-ratio: 1; background: #1a1a1a; border: 1px solid #00aa00; font-size: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .heatmap-cell.hot { background: #ff0000; color: #fff; }
        .heatmap-cell.warm { background: #ffaa00; color: #000; }
        .heatmap-cell.cool { background: #00ff00; color: #000; }
        
        .freq-item { background: #1a1a1a; padding: 4px; margin-bottom: 3px; border-left: 2px solid #00ff00; font-size: 10px; display: flex; justify-content: space-between; align-items: center; }
        .freq-toggle { width: 40px; padding: 3px; background: #003300; color: #00ff00; border: 1px solid #00ff00; cursor: pointer; font-size: 9px; font-weight: bold; }
        .freq-toggle.active { background: #00ff00; color: #000; }
        
        .triangulation-display { background: #1a1a1a; border: 1px solid #00ccff; padding: 6px; margin-bottom: 6px; font-size: 10px; }
        .triangulation-coord { color: #00ccff; font-weight: bold; font-size: 11px; }
        
        .infrastructure-marker { background: #1a1a1a; padding: 4px; margin-bottom: 3px; border-left: 2px solid #ffff00; font-size: 10px; }
        .marker-label { color: #ffff00; font-weight: bold; }
        
        .view-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-bottom: 6px; }
        .view-toggle button { font-size: 10px; padding: 6px; }
    </style>
</head>
<body>
    <div id="app">
        <!-- LEFT: Advanced Radar with 3D -->
        <div id="radar">
            <div class="view-toggle">
                <button onclick="toggle2D3D()" id="viewBtn">üì° 2D RADAR</button>
                <button onclick="toggleInfraMarkers()" id="infraBtn">üó∫Ô∏è MARKERS</button>
            </div>
            <canvas id="canvas"></canvas>
        </div>

        <!-- RIGHT: Quad Panel System -->
        <div id="main-panel">
            <!-- Control Panel -->
            <div id="control-panel">
                <div id="status">üîÑ Init...</div>

                <div class="box" style="flex: 0 0 auto;">
                    <h3>üéØ THREAT MATRIX</h3>
                    <div class="stat"><span>Detected:</span><span class="stat-val" id="det">0</span></div>
                    <div class="stat"><span>Threats:</span><span class="stat-val red" id="thr">0</span></div>
                    <div class="stat"><span>Jammed:</span><span class="stat-val yellow" id="jam">0</span></div>
                </div>

                <div class="box" style="flex: 0 0 auto;">
                    <h3>üé¨ SPAWN</h3>
                    <div class="button-grid">
                        <button onclick="spawn('hostile')" class="sm">+ Hostile</button>
                        <button onclick="spawn('ally')" class="sm">+ Ally</button>
                        <button onclick="spawn('swarm')" class="sm">+ Swarm</button>
                        <button onclick="resetSim()" class="danger wide sm">RESET</button>
                    </div>
                </div>

                <div class="box" style="flex: 0 0 auto;">
                    <h3>‚öîÔ∏è ESCALATION</h3>
                    <div style="display: flex; gap: 3px; font-size: 10px;">
                        <div id="step1" class="escalation-step">DETECT</div>
                        <div id="step2" class="escalation-step">ID</div>
                        <div id="step3" class="escalation-step">JAM</div>
                    </div>
                </div>

                <div class="box" style="flex: 0 0 auto;">
                    <h3>üéØ ACTIONS</h3>
                    <button onclick="jamAll()" class="danger wide sm">GLOBAL JAM</button>
                    <button onclick="jamSelected()" class="wide sm" style="color: #ffaa00; border-color: #ffaa00; margin-top: 3px;">SELECTIVE</button>
                    <button onclick="togglePrecisionMode()" id="precisionBtn" class="sm wide" style="color: #00ccff; border-color: #00ccff; margin-top: 3px;">PRECISION</button>
                    <button onclick="togglePrediction()" id="predictionBtn" class="sm wide" style="color: #cc00ff; border-color: #cc00ff;">PREDICT AI</button>
                </div>

                <div class="box" style="flex: 1; min-height: 100px;">
                    <h3>üìã MISSION LOG</h3>
                    <div id="log"></div>
                </div>
            </div>

            <!-- Intelligence Panel (Middle) -->
            <div id="intel-panel" style="flex: 0 0 330px;">
                <div class="box" style="flex: 0 0 auto;">
                    <h3>üî∑ FORMATION</h3>
                    <div id="formation-display" style="color: #00aa00; padding: 4px; font-size: 10px;">Awaiting data...</div>
                </div>

                <div class="box" style="flex: 0 0 auto;">
                    <h3>‚ö° PRIORITY</h3>
                    <div id="priority-matrix" style="font-size: 10px;"></div>
                </div>

                <div class="box" style="flex: 0 0 auto;">
                    <h3>üìä EFFECTIVENESS</h3>
                    <div style="font-size: 10px;">
                        <div>Success: <span id="jamEffectiveness" style="color: #00ff00; font-weight: bold; font-size: 12px;">0%</span></div>
                        <div class="effectiveness-bar">
                            <div id="jamBar" class="effectiveness-fill" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="box" style="flex: 0 0 auto;">
                    <h3>üî• HEATMAP</h3>
                    <div id="heatmap"></div>
                </div>

                <div class="box" style="flex: 1;">
                    <h3>üìú TIMELINE</h3>
                    <div id="timeline" style="overflow-y: auto; max-height: 180px; font-size: 10px;"></div>
                </div>
            </div>

            <!-- Tactical Layers Panel (Right) -->
            <div id="intel-panel" style="flex: 0 0 330px;">
                <!-- Selective Disruption -->
                <div class="box" style="flex: 0 0 auto;">
                    <h3>üîí DISRUPTION</h3>
                    <div id="freq-list" style="font-size: 10px;"></div>
                </div>

                <!-- Operator Triangulation -->
                <div class="box" style="flex: 0 0 auto;">
                    <h3>üìç TRIANGULATION</h3>
                    <div id="triangulation" class="triangulation-display">No jam data</div>
                </div>

                <!-- Infrastructure Markers -->
                <div class="box" style="flex: 0 0 auto;">
                    <h3>üó∫Ô∏è PROTECTED SITES</h3>
                    <button onclick="addMarker()" class="wide sm" style="margin-bottom: 4px;">+ Add Site</button>
                    <div id="markers" style="font-size: 10px;"></div>
                </div>

                <!-- RF Database -->
                <div class="box" style="flex: 1;">
                    <h3>üì° RF SIGNATURES</h3>
                    <div id="rf-database" style="font-size: 10px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let canvas, ctx, drones = [], selectedDrone = null;
        let precisionMode = false, predictionMode = false, view3D = false, showMarkers = true;
        let rfDatabase = {}, engagementHistory = [], heatmapGrid = Array(25).fill(0);
        let lastFormationState = null, jamAttempts = 0, jamSuccesses = 0;
        let infrastructureMarkers = [], triangulationPoint = null;
        let selectedFrequencies = { police: true, fire: true, military: true, cellular: true, lte: true };

        const frequencies = {
            police: { name: 'Police Comms', range: '400-512 MHz', color: '#00aa00' },
            fire: { name: 'Fire/EMS', range: '154-174 MHz', color: '#ff6600' },
            military: { name: 'Military', range: '225-400 MHz', color: '#ff0000' },
            cellular: { name: 'Cellular', range: '800-2400 MHz', color: '#00ccff' },
            lte: { name: 'LTE/WiFi', range: '2.4-5.8 GHz', color: '#ffff00' }
        };

        function log(msg, type = 'detect') {
            const el = document.getElementById('log');
            const div = document.createElement('div');
            div.className = 'log-line ' + type;
            const t = new Date().toLocaleTimeString();
            div.textContent = `[${t}] ${msg}`;
            el.insertBefore(div, el.firstChild);
            if (el.children.length > 20) el.removeChild(el.lastChild);
            
            engagementHistory.unshift({ time: t, msg, type });
            if (engagementHistory.length > 30) engagementHistory.pop();
            updateTimeline();
        }

        function toPixel(gx, gy) {
            const padding = 20;
            const usableW = canvas.width - padding * 2;
            const usableH = canvas.height - padding * 2;
            return { x: padding + (gx / 100) * usableW, y: padding + (gy / 100) * usableH };
        }

        function toggle2D3D() {
            view3D = !view3D;
            document.getElementById('viewBtn').textContent = view3D ? 'üé¨ 3D VIEW' : 'üì° 2D RADAR';
            log(view3D ? 'MODE: 3D perspective activated' : 'MODE: 2D radar restored', 'ai');
        }

        function toggleInfraMarkers() {
            showMarkers = !showMarkers;
            document.getElementById('infraBtn').style.opacity = showMarkers ? '1' : '0.5';
            log(showMarkers ? 'MARKERS: Infrastructure displayed' : 'MARKERS: Hidden', 'detect');
        }

        function draw() {
            if (!ctx) return;
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (view3D) draw3D();
            else draw2D();
        }

        function draw2D() {
            ctx.strokeStyle = '#003300';
            ctx.lineWidth = 0.5;
            const step = canvas.width / 10;
            for (let i = 0; i <= 10; i++) {
                ctx.beginPath();
                ctx.moveTo(i * step, 0);
                ctx.lineTo(i * step, canvas.height);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, i * step);
                ctx.lineTo(canvas.width, i * step);
                ctx.stroke();
            }

            drawDefenseZones();
            if (showMarkers) drawInfrastructureMarkers();
            const base = toPixel(50, 50);
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(base.x, base.y, 15, 0, Math.PI * 2);
            ctx.stroke();

            if (predictionMode) {
                drones.forEach(d => {
                    if (d.side !== 'ally') drawPredictionPath(d);
                });
            }

            drones.forEach(d => drawDrone(d));
        }

        function draw3D() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const maxDist = Math.min(canvas.width, canvas.height) / 2 - 40;

            ctx.strokeStyle = '#003300';
            ctx.lineWidth = 0.5;
            for (let i = 1; i <= 5; i++) {
                const r = (maxDist / 5) * i;
                ctx.beginPath();
                ctx.arc(centerX, centerY, r, 0, Math.PI * 2);
                ctx.stroke();
            }

            for (let angle = 0; angle < 360; angle += 45) {
                const rad = (angle * Math.PI) / 180;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(centerX + Math.cos(rad) * maxDist, centerY + Math.sin(rad) * maxDist);
                ctx.stroke();
            }

            ctx.fillStyle = '#00ff00';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 8, 0, Math.PI * 2);
            ctx.fill();

            drones.forEach(d => {
                const angle = (d.head * Math.PI) / 180;
                const dist = (Math.sqrt((d.x - 50) ** 2 + (d.y - 50) ** 2) / 70.7) * maxDist;
                const x = centerX + Math.cos(angle) * dist;
                const y = centerY + Math.sin(angle) * dist;

                let col = '#00ff00';
                if (d.side === 'ally') col = '#00ffff';
                else if (d.mode === 'jammed') col = '#ffff00';
                else if (d.threat > 70) col = '#ff0000';

                ctx.fillStyle = col;
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = col;
                ctx.font = 'bold 9px Courier';
                ctx.textAlign = 'center';
                ctx.fillText(d.name, x, y - 10);
            });
        }

        function drawDefenseZones() {
            const base = toPixel(50, 50);
            const zones = [
                { dist: 30, color: '#ff0000' },
                { dist: 60, color: '#ffaa00' },
                { dist: 120, color: '#00ff00' },
                { dist: 240, color: '#0099ff' }
            ];
            zones.forEach(zone => {
                ctx.strokeStyle = zone.color;
                ctx.lineWidth = 0.5;
                ctx.globalAlpha = 0.2;
                ctx.beginPath();
                ctx.arc(base.x, base.y, zone.dist, 0, Math.PI * 2);
                ctx.stroke();
                ctx.globalAlpha = 1;
            });
        }

        function drawInfrastructureMarkers() {
            infrastructureMarkers.forEach(m => {
                const p = toPixel(m.x, m.y);
                ctx.fillStyle = '#ffff00';
                ctx.globalAlpha = 0.6;
                ctx.beginPath();
                ctx.rect(p.x - 10, p.y - 10, 20, 20);
                ctx.fill();
                ctx.globalAlpha = 1;

                ctx.fillStyle = '#ffff00';
                ctx.font = '10px Courier';
                ctx.textAlign = 'center';
                ctx.fillText(m.label, p.x, p.y + 15);
            });
        }

        function drawDrone(d) {
            const p = toPixel(d.x, d.y);
            let col = '#00ff00';
            if (d.side === 'ally') col = '#00ffff';
            else if (d.mode === 'jammed') col = '#ffff00';
            else if (d.threat > 70) col = '#ff0000';
            else if (d.threat > 40) col = '#ffaa00';

            if (d.side !== 'ally') {
                ctx.strokeStyle = col;
                ctx.lineWidth = 0.5;
                ctx.globalAlpha = 0.3;
                for (let i = 0; i < 3; i++) {
                    const wave = 5 + (Date.now() % 1000) / 1000 * 10 + i * 5;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, wave, 0, Math.PI * 2);
                    ctx.stroke();
                }
                ctx.globalAlpha = 1;
            }

            ctx.fillStyle = col;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
            ctx.fill();

            ctx.strokeStyle = col;
            ctx.lineWidth = 1;
            ctx.beginPath();
            const rad = (d.head * Math.PI) / 180;
            ctx.moveTo(p.x, p.y);
            ctx.lineTo(p.x + Math.cos(rad) * 8, p.y + Math.sin(rad) * 8);
            ctx.stroke();

            ctx.fillStyle = col;
            ctx.font = 'bold 9px Courier';
            ctx.textAlign = 'center';
            ctx.fillText(d.name, p.x, p.y - 12);
            ctx.font = '8px Courier';
            ctx.fillText(`${d.threat.toFixed(0)}%`, p.x, p.y + 12);

            if (precisionMode && d.side !== 'ally') {
                ctx.strokeStyle = '#00ccff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.rect(p.x - 15, p.y - 15, 30, 30);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(p.x - 10, p.y);
                ctx.lineTo(p.x + 10, p.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(p.x, p.y - 10);
                ctx.lineTo(p.x, p.y + 10);
                ctx.stroke();
            }
        }

        function drawPredictionPath(d) {
            const p = toPixel(d.x, d.y);
            let predX = d.x, predY = d.y;
            const rad = (d.head * Math.PI) / 180;

            ctx.strokeStyle = '#cc00ff';
            ctx.lineWidth = 1;
            ctx.globalAlpha = 0.4;
            ctx.setLineDash([5, 5]);

            for (let i = 0; i < 5; i++) {
                predX += Math.cos(rad) * (d.spd / 100);
                predY += Math.sin(rad) * (d.spd / 100);
                const nextP = toPixel(predX, predY);
                ctx.beginPath();
                ctx.arc(nextP.x, nextP.y, 3, 0, Math.PI * 2);
                ctx.stroke();
            }

            ctx.setLineDash([]);
            ctx.globalAlpha = 1;
        }

        function spawn(type) {
            if (type === 'hostile') {
                drones.push({
                    name: `H-${drones.filter(d => d.side === 'hostile').length + 1}`,
                    x: Math.random() * 100, y: Math.random() * 100,
                    spd: 15 + Math.random() * 20, head: Math.random() * 360,
                    rf: 40 + Math.random() * 60, rfBase: null,
                    side: 'hostile', mode: 'normal', threat: 0, threatBase: null,
                    jamCount: 0, droneType: 'Unknown', priority: 0, freqBand: Object.keys(frequencies)[Math.floor(Math.random() * 5)]
                });
                log('DETECTION: Hostile acquired', 'detect');
            } else if (type === 'ally') {
                drones.push({
                    name: `A-${drones.filter(d => d.side === 'ally').length + 1}`,
                    x: Math.random() * 100, y: Math.random() * 100,
                    spd: 10, head: Math.random() * 360, rf: 10,
                    side: 'ally', mode: 'normal', threat: 0
                });
                log('FRIENDLY: Allied unit', 'detect');
            } else if (type === 'swarm') {
                const bx = 30 + Math.random() * 40;
                const by = 30 + Math.random() * 40;
                const baseHeading = Math.random() * 360;
                const baseSpeed = 20 + Math.random() * 10;
                
                // Formation choice: DIAMOND, WEDGE, LINE, or SCATTERED
                const formationType = Math.floor(Math.random() * 4);
                let formationName = 'SCATTERED';
                
                // DIAMOND: Tight clustered formation (25% chance)
                if (formationType === 0) {
                    formationName = 'DIAMOND';
                    for (let i = 0; i < 5; i++) {
                        const angle = (i * 72);
                        const dist = 2 + Math.random() * 1;
                        const dx = Math.cos((angle * Math.PI) / 180) * dist;
                        const dy = Math.sin((angle * Math.PI) / 180) * dist;
                        
                        drones.push({
                            name: `S-${i+1}`,
                            x: bx + dx, y: by + dy,
                            spd: baseSpeed + (Math.random() - 0.5) * 2,
                            head: baseHeading + (Math.random() - 0.5) * 15,
                            rf: 60 + Math.random() * 30, rfBase: null,
                            side: 'hostile', mode: 'normal', threat: 0, threatBase: null,
                            jamCount: 0, droneType: 'Swarm Unit', priority: 0, 
                            freqBand: Object.keys(frequencies)[Math.floor(Math.random() * 5)]
                        });
                    }
                }
                // WEDGE: V-formation (25% chance)
                else if (formationType === 1) {
                    formationName = 'WEDGE';
                    for (let i = 0; i < 5; i++) {
                        const row = Math.floor(i / 2);
                        const col = i % 2;
                        const dx = col * 3 - 1.5;
                        const dy = row * 2.5;
                        
                        drones.push({
                            name: `S-${i+1}`,
                            x: bx + dx, y: by + dy,
                            spd: baseSpeed + (Math.random() - 0.5) * 2,
                            head: baseHeading + (Math.random() - 0.5) * 10,
                            rf: 60 + Math.random() * 30, rfBase: null,
                            side: 'hostile', mode: 'normal', threat: 0, threatBase: null,
                            jamCount: 0, droneType: 'Swarm Unit', priority: 0,
                            freqBand: Object.keys(frequencies)[Math.floor(Math.random() * 5)]
                        });
                    }
                }
                // LINE: Single file (25% chance)
                else if (formationType === 2) {
                    formationName = 'LINE';
                    for (let i = 0; i < 5; i++) {
                        const dx = 0;
                        const dy = i * 3;
                        
                        drones.push({
                            name: `S-${i+1}`,
                            x: bx + dx, y: by + dy,
                            spd: baseSpeed + (Math.random() - 0.5) * 1,
                            head: baseHeading + (Math.random() - 0.5) * 5,
                            rf: 60 + Math.random() * 30, rfBase: null,
                            side: 'hostile', mode: 'normal', threat: 0, threatBase: null,
                            jamCount: 0, droneType: 'Swarm Unit', priority: 0,
                            freqBand: Object.keys(frequencies)[Math.floor(Math.random() * 5)]
                        });
                    }
                }
                // SCATTERED: Random spread (25% chance)
                else {
                    formationName = 'SCATTERED';
                    for (let i = 0; i < 5; i++) {
                        drones.push({
                            name: `S-${i+1}`,
                            x: bx + (Math.random() - 0.5) * 20, y: by + (Math.random() - 0.5) * 20,
                            spd: 20 + Math.random() * 15, head: Math.random() * 360,
                            rf: 60 + Math.random() * 30, rfBase: null,
                            side: 'hostile', mode: 'normal', threat: 0, threatBase: null,
                            jamCount: 0, droneType: 'Swarm Unit', priority: 0,
                            freqBand: Object.keys(frequencies)[Math.floor(Math.random() * 5)]
                        });
                    }
                }
                
                log(`THREAT: Swarm detected (5) - ${formationName}`, 'ai');
            }
            updateIntelligence();
        }

        function jamAll() {
            let cnt = 0;
            drones.forEach(d => {
                if (d.side !== 'ally' && d.mode !== 'jammed') {
                    d.mode = 'jammed';
                    d.jamTime = Date.now();
                    d.jamCount = (d.jamCount || 0) + 1;
                    cnt++;
                    jamAttempts++;
                    jamSuccesses++;
                }
            });
            log(`ESCALATION: Global jam (${cnt} targets)`, 'jam');
            updateTriangulation();
        }

        function jamSelected() {
            let cnt = 0;
            drones.forEach(d => {
                if (d.side !== 'ally' && d.mode !== 'jammed' && selectedFrequencies[d.freqBand]) {
                    d.mode = 'jammed';
                    d.jamTime = Date.now();
                    d.jamCount = (d.jamCount || 0) + 1;
                    cnt++;
                    jamAttempts++;
                    jamSuccesses++;
                }
            });
            log(`SELECTIVE: Jammed ${cnt} on active bands`, 'jam');
            updateTriangulation();
        }

        function resetSim() {
            drones = [];
            selectedDrone = null;
            rfDatabase = {};
            engagementHistory = [];
            heatmapGrid = Array(25).fill(0);
            jamAttempts = 0;
            jamSuccesses = 0;
            triangulationPoint = null;
            log('SYSTEM: Reset', 'detect');
            updateIntelligence();
        }

        function togglePrecisionMode() {
            precisionMode = !precisionMode;
            const btn = document.getElementById('precisionBtn');
            precisionMode ? btn.classList.add('active') : btn.classList.remove('active');
            log(precisionMode ? 'PRECISION: Active' : 'PRECISION: Off', 'ai');
        }

        function togglePrediction() {
            predictionMode = !predictionMode;
            const btn = document.getElementById('predictionBtn');
            predictionMode ? btn.classList.add('active') : btn.classList.remove('active');
            log(predictionMode ? 'PREDICT AI: Active' : 'PREDICT AI: Off', 'ai');
        }

        function addMarker() {
            infrastructureMarkers.push({
                label: `Site-${infrastructureMarkers.length + 1}`,
                x: 30 + Math.random() * 40,
                y: 30 + Math.random() * 40,
                type: ['Airport', 'Port', 'Military', 'Hospital', 'Power Plant'][Math.floor(Math.random() * 5)]
            });
            updateMarkers();
            log(`MARKER: ${infrastructureMarkers[infrastructureMarkers.length - 1].type} added`, 'detect');
        }

        function updateMarkers() {
            const html = infrastructureMarkers.map((m, i) => {
                return `<div class="infrastructure-marker">
                    <span class="marker-label">${m.label}</span> - ${m.type}
                    <button onclick="removeMarker(${i})" class="sm" style="float: right; width: 50px;">‚úï</button>
                </div>`;
            }).join('');
            document.getElementById('markers').innerHTML = html || '<div style="color: #00aa00;">No markers</div>';
        }

        function removeMarker(idx) {
            infrastructureMarkers.splice(idx, 1);
            updateMarkers();
        }

        function updateTriangulation() {
            const jammed = drones.filter(d => d.mode === 'jammed' && d.side !== 'ally');
            if (jammed.length > 0) {
                const avgX = jammed.reduce((s, d) => s + d.x, 0) / jammed.length;
                const avgY = jammed.reduce((s, d) => s + d.y, 0) / jammed.length;
                triangulationPoint = { x: avgX, y: avgY };
                
                document.getElementById('triangulation').innerHTML = `
                    <div class="triangulation-coord">ESTIMATED POS</div>
                    <div style="color: #00ff00; font-size: 11px; font-weight: bold;">X: ${(avgX * 1000 / 100).toFixed(0)}m</div>
                    <div style="color: #00ff00; font-size: 11px; font-weight: bold;">Y: ${(avgY * 1000 / 100).toFixed(0)}m</div>
                    <div style="color: #ffff00; margin-top: 4px; font-size: 10px;">Confidence: ${(80 + Math.random() * 15).toFixed(0)}%</div>
                `;
            }
        }

        function analyzeFormation() {
            const hostiles = drones.filter(d => d.side === 'hostile');
            if (hostiles.length < 3) return 'SCATTERED';

            const avgX = hostiles.reduce((s, d) => s + d.x, 0) / hostiles.length;
            const avgY = hostiles.reduce((s, d) => s + d.y, 0) / hostiles.length;

            let maxDist = 0, minDist = 999;
            hostiles.forEach(d => {
                const dist = Math.sqrt((d.x - avgX) ** 2 + (d.y - avgY) ** 2);
                maxDist = Math.max(maxDist, dist);
                minDist = Math.min(minDist, dist);
            });

            const cohesion = maxDist - minDist;
            if (cohesion < 5) return 'DIAMOND';
            if (cohesion < 10) return 'WEDGE';
            if (cohesion < 15) return 'LINE';
            return 'SCATTER';
        }

        function updateRFDatabase() {
            drones.forEach(d => {
                if (d.side === 'hostile' && !d.rfBase) {
                    d.rfBase = d.rf;
                    const types = ['DJI Phantom 4', 'DJI Mavic 3', 'Freefly', 'Yuneec', 'Auterion'];
                    d.droneType = types[Math.floor(Math.random() * types.length)];
                    
                    if (!rfDatabase[d.droneType]) {
                        rfDatabase[d.droneType] = { count: 0, signatures: [] };
                    }
                    rfDatabase[d.droneType].count++;
                    rfDatabase[d.droneType].signatures.push(d.rf.toFixed(1));
                }
            });

            const dbHTML = Object.entries(rfDatabase).map(([type, data]) => {
                return `<div class="rf-entry">
                    <div class="rf-id">${type}</div>
                    <div class="rf-match">Hits: ${data.count} | Avg: ${(data.signatures.reduce((a,b) => a + parseFloat(b), 0) / data.signatures.length).toFixed(1)} dBm</div>
                </div>`;
            }).join('');

            document.getElementById('rf-database').innerHTML = dbHTML || '<div style="color: #00aa00;">Scanning...</div>';
        }

        function updateFrequencyList() {
            const html = Object.entries(frequencies).map(([key, freq]) => {
                return `<div class="freq-item">
                    <span>${freq.name}</span>
                    <button class="freq-toggle ${selectedFrequencies[key] ? 'active' : ''}" onclick="toggleFrequency('${key}')" style="background-color: ${selectedFrequencies[key] ? freq.color : '#1a1a1a'}; border-color: ${freq.color};">
                        ${selectedFrequencies[key] ? '‚úì' : '‚óã'}
                    </button>
                </div>`;
            }).join('');
            document.getElementById('freq-list').innerHTML = html;
        }

        function toggleFrequency(key) {
            selectedFrequencies[key] = !selectedFrequencies[key];
            updateFrequencyList();
            log(`BAND: ${frequencies[key].name} ${selectedFrequencies[key] ? 'ACTIVE' : 'INACTIVE'}`, 'ai');
        }

        function calculatePriority() {
            drones.forEach(d => {
                if (d.side === 'hostile') {
                    const distToBase = Math.sqrt((d.x - 50) ** 2 + (d.y - 50) ** 2);
                    const threatScore = d.threat || 50;
                    const evasionFactor = d.mode === 'jammed' ? 0 : 1;
                    d.priority = (threatScore * 0.4) + ((100 - distToBase) * 0.4) + (evasionFactor * 0.2) * 100;
                }
            });

            const hostiles = drones.filter(d => d.side === 'hostile').sort((a, b) => b.priority - a.priority);
            const matrixHTML = hostiles.slice(0, 4).map((d, i) => {
                const fillWidth = Math.min(100, d.priority);
                return `<div class="priority-row">
                    <div class="priority-name">${d.name}</div>
                    <div class="priority-bar">
                        <div class="priority-fill" style="width: ${fillWidth}%;"><span class="priority-label">${d.priority.toFixed(0)}%</span></div>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('priority-matrix').innerHTML = matrixHTML || '<div style="color: #00aa00; font-size: 10px;">No threats</div>';
        }

        function updateHeatmap() {
            drones.forEach(d => {
                if (d.mode === 'jammed') {
                    const cellX = Math.floor(d.x / 20);
                    const cellY = Math.floor(d.y / 20);
                    const idx = cellY * 5 + cellX;
                    if (idx >= 0 && idx < 25) heatmapGrid[idx]++;
                }
            });

            const maxHeat = Math.max(...heatmapGrid) || 1;
            const heatHTML = heatmapGrid.map(val => {
                const intensity = val / maxHeat;
                let className = 'heatmap-cell';
                if (intensity > 0.7) className += ' hot';
                else if (intensity > 0.4) className += ' warm';
                else if (intensity > 0.1) className += ' cool';
                return `<div class="${className}">${val}</div>`;
            }).join('');

            document.getElementById('heatmap').innerHTML = `<div class="heatmap-grid">${heatHTML}</div>`;
        }

        function updateTimeline() {
            const timelineHTML = engagementHistory.map(e => {
                return `<div class="timeline-item">
                    <span class="timeline-time">${e.time}</span> ${e.msg}
                </div>`;
            }).join('');

            document.getElementById('timeline').innerHTML = timelineHTML || '<div style="color: #00aa00; font-size: 10px;">No events</div>';
        }

        function updateIntelligence() {
            const hostiles = drones.filter(d => d.side === 'hostile');
            
            const formation = analyzeFormation();
            if (!lastFormationState) lastFormationState = { type: formation, cohesion: 70, count: hostiles.length };
            
            if (hostiles.length !== lastFormationState.count) {
                lastFormationState = { type: formation, cohesion: Math.random() * 40 + 60, count: hostiles.length };
            }
            
            const formationHTML = hostiles.length > 0
                ? `<div class="formation-display">
                    <div class="formation-type">${formation}</div>
                    <div class="formation-info">Cohesion: ${lastFormationState.cohesion.toFixed(0)}%</div>
                  </div>`
                : '<div style="color: #00aa00; padding: 4px; font-size: 10px;">Awaiting data...</div>';
            document.getElementById('formation-display').innerHTML = formationHTML;

            updateRFDatabase();
            calculatePriority();
            updateHeatmap();

            const effectiveness = jamAttempts > 0 ? (jamSuccesses / jamAttempts * 100) : 0;
            document.getElementById('jamEffectiveness').textContent = effectiveness.toFixed(0) + '%';
            document.getElementById('jamBar').style.width = effectiveness + '%';
        }

        function update() {
            const det = drones.length;
            const thr = drones.filter(d => d.threat > 70).length;
            const jam = drones.filter(d => d.mode === 'jammed').length;

            document.getElementById('det').textContent = det;
            document.getElementById('thr').textContent = thr;
            document.getElementById('jam').textContent = jam;

            ['step1', 'step2', 'step3'].forEach((id, idx) => {
                const el = document.getElementById(id);
                const hasData = [det > 0, thr > 0, jam > 0][idx];
                el.classList.toggle('active', hasData);
            });
        }

        function loop() {
            draw();

            drones.forEach(d => {
                d.x += Math.cos((d.head * Math.PI) / 180) * (d.spd / 100);
                d.y += Math.sin((d.head * Math.PI) / 180) * (d.spd / 100);

                if (d.x < 0) d.x = 100;
                if (d.x > 100) d.x = 0;
                if (d.y < 0) d.y = 100;
                if (d.y > 100) d.y = 0;

                if (d.side !== 'ally') {
                    if (!d.threatBase) d.threatBase = 40 + Math.random() * 60;
                    d.threat = d.threatBase;
                    if (d.mode === 'jammed') d.threat *= 0.5;
                }

                if (d.mode === 'jammed') {
                    const t = (Date.now() - d.jamTime) / 1000;
                    if (t > 3) d.spd *= 0.95;
                }
            });

            update();
            updateIntelligence();
            requestAnimationFrame(loop);
        }

        window.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width - 10;
            canvas.height = rect.height - 10;

            window.addEventListener('resize', () => {
                const r = canvas.parentElement.getBoundingClientRect();
                canvas.width = r.width - 10;
                canvas.height = r.height - 10;
            });

            updateFrequencyList();

            setTimeout(() => {
                document.getElementById('status').textContent = '‚úÖ NSD v12.4 ONLINE';
                document.getElementById('status').classList.add('ready');
                spawn('hostile');
                spawn('ally');
                addMarker();
                log('SYSTEM: v12.4 initialized - Formation AI Enhanced', 'detect');
                log('TACTICAL: All layers active', 'ai');
                loop();
            }, 500);
        });
    </script>
</body>
</html>
